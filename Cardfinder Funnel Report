ALTER SESSION SET WEEK_START = 7;

with form_starts as (
select d.PAGEVIEW_DT as DW_EFF_DT
, d.SESSION_ID
, min(d.received_ts) as form_start_ts
from NEXUS.PROD.F_PAGEVIEW d
where d.pageview_url_path ilike '%recommend%'
--and d.PAGEVIEW_DT >= '2023-09-04'
and d.PAGEVIEW_DT >= '2025-01-22'
and d.PAGEVIEW_DT < date_trunc('WEEK', current_date)
and d.SUPPLEMENTARY:CONTEXT_PAGE_SEARCH::STRING <> '?trk_location=cc_super_bowl' 

group by 1,2
)
, form_completes as(
select d.PAGEVIEW_DT as DW_EFF_DT
, d.SESSION_ID
, min(d.pageview_ts) as complete_ts
from NEXUS.PROD.F_PAGEVIEW d
where
d.page_name = 'cc_match_results_page'
--and d.PAGEVIEW_DT >= '2023-09-04'
and d.PAGEVIEW_DT >= '2025-01-22'
and d.PAGEVIEW_DT < date_trunc('WEEK', current_date)
group by 1,2
)
,  mclicks_t as (
select mc.DW_EFF_DT
, mc.SESSION_ID
, count(mc.shopping_finish_id) as mclicks_1
from corp_mart.prod.i_mclicks mc
where
(mc.IMPRESSION_PAGE_URL_PATH ilike '%recommend%' or mc.IMPRESSION_PAGE_URL_PATH ilike '%pers-rec-results%')
and mc.reporting_product_type = 'Credit Cards'
--and mc.DW_EFF_DT >= '2023-09-04'
and mc.DW_EFF_DT >= '2025-01-22'
and mc.DW_EFF_DT < date_trunc('WEEK',current_date)
group by 1,2
)

,txns_t as
(select t.DW_EFF_DT
, t.session_id
, sum(t.transaction_count) as txns_1
from corp_mart.prod.i_revenue_affiliate_transactions t
where
(t.impression_page_url_path ilike '%recommend%' or t.impression_page_url_path ilike '%pers-rec-results%')
and t.reporting_product_type = 'Credit Cards'
--and t.DW_EFF_DT >= '2023-09-04'
and t.DW_EFF_DT >= '2025-01-22'
and t.DW_EFF_DT < date_trunc('WEEK',current_date)
group by 1,2)

,revenue_t as
(select t.DW_EFF_DT
, t.session_id
, sum(t.revenue_ingested) as revenue_1
from corp_mart.prod.i_revenue_affiliate_transactions t
where
(t.impression_page_url_path ilike '%recommend%' or t.impression_page_url_path ilike '%pers-rec-results%')
and t.reporting_product_type = 'Credit Cards'
--and t.DW_EFF_DT >= '2023-09-04'
and t.DW_EFF_DT >= '2025-01-22'
and t.DW_EFF_DT < date_trunc('WEEK',current_date)
group by 1,2)



select date_trunc('WEEK', coalesce(f.DW_EFF_DT, c.DW_EFF_DT, m.DW_EFF_DT, t.dw_eff_dt, r.dw_eff_dt)) as week_of
, count(distinct f.SESSION_ID) as form_starts
, count(distinct c.SESSION_ID) as completes
, sum(mclicks_1) as mclicks
, sum(txns_1) as txns
, sum(revenue_1) as revenue
, completes/nullifzero(form_starts) as cpfs
, mclicks/nullifzero(form_starts) as mcps_start
, txns/nullifzero(form_starts) as nconv_start
, revenue/nullifzero(form_starts) as arps_start
, txns/nullifzero(mclicks) as cconv
, mclicks/nullifzero(completes) as mcps_com
, txns/nullifzero(completes) as nconv_com
, revenue/nullifzero(completes) as arps_com
from form_starts f
left join form_completes c
on f.SESSION_ID = c.SESSION_ID
left join mclicks_t m
on m.SESSION_ID = c.SESSION_ID
left join txns_t t
on t.session_id = c.session_id
left join revenue_t r
on r.session_id = c.session_id
group by all order by 1;
